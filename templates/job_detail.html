{% extends "base.html" %}

{% block title %}{{ job.title }} - Job Search{% endblock %}

{% block content %}
<div class="breadcrumb">
    {% if request.args.get('from') == 'review' %}
        <a href="{{ url_for('index', status='new') }}">← Back to Queue</a>
    {% else %}
        <a href="{{ url_for('index') }}">← Back to Jobs</a>
    {% endif %}
</div>

<article class="job-detail">
    <header class="job-detail-header">
        <h1>{{ job.title }}</h1>
        <div class="job-detail-meta">
            <span class="status-badge status-{{ job.status }}">{{ job.status }}</span>
            {% if job.score %}
                <span class="score-badge">{{ job.score }}/10</span>
            {% endif %}
        </div>
    </header>

    <div class="job-info">
        <div class="info-row">
            <strong>Source:</strong> {{ job.source or 'Unknown' }}
        </div>
        {% if job.feed %}
        <div class="info-row">
            <strong>Feed:</strong> {{ job.feed }}
        </div>
        {% endif %}
        {% if job.posted_date %}
        <div class="info-row">
            <strong>Posted:</strong> {{ job.posted_date }}
        </div>
        {% endif %}
        {% if job.location_label %}
        <div class="info-row">
            <strong>Location:</strong> <span class="location-label location-{{ job.location_label|lower|replace(' ', '-') }}">{{ job.location_label }}</span>
        </div>
        {% endif %}
        {% if job.job_type %}
        <div class="info-row">
            <strong>Job Type:</strong> <span class="job-type">{{ job.job_type }}</span>
        </div>
        {% endif %}
        {% if job.pay_range %}
        <div class="info-row">
            <strong>
                {% if job.job_type == 'Full-time' %}
                Salary Range:
                {% elif job.job_type == 'Contract' %}
                Hourly Rate:
                {% else %}
                Pay Range:
                {% endif %}
            </strong>
            <span class="pay-range">{{ job.pay_range }}</span>
        </div>
        {% endif %}
        {% if job.contract_duration and job.job_type == 'Contract' %}
        <div class="info-row">
            <strong>Contract Duration:</strong> <span class="contract-duration">{{ job.contract_duration }}</span>
        </div>
        {% endif %}
        <div class="info-row">
            <strong>URL:</strong> <a href="{{ job.url }}" target="_blank">{{ job.url }}</a>
        </div>
    </div>

    {% if job.description %}
    <section class="job-description">
        <h2>Description</h2>
        <div class="description-content">{{ job.description|strip_html }}</div>
    </section>
    {% endif %}

    {% if job.score_rationale %}
    <section class="score-rationale">
        <h2>Score Rationale</h2>
        <p>{{ job.score_rationale }}</p>
    </section>
    {% endif %}

    {% if job.notes %}
    <section class="job-notes">
        <h2>Notes</h2>
        <p>{{ job.notes }}</p>
    </section>
    {% endif %}

    {% if request.args.get('from') == 'review' and job.status == 'new' %}
    <section class="review-actions-section">
        <div class="review-progress">
            Reviewing {{ review_count }} new job{{ 's' if review_count != 1 else '' }}
        </div>
        <div class="review-actions">
            <form method="post" action="{{ url_for('review_job', job_id=job.id) }}">
                <input type="hidden" name="action" value="interested">
                <button type="submit" class="btn-interested">Interested</button>
            </form>
            <form method="post" action="{{ url_for('review_job', job_id=job.id) }}">
                <input type="hidden" name="action" value="skip">
                <button type="submit" class="btn-skip">Skip</button>
            </form>
            <form method="post" action="{{ url_for('review_job', job_id=job.id) }}" class="pass-form">
                <input type="hidden" name="action" value="pass">
                <button type="submit" class="btn-pass">Pass</button>
                <input type="text" name="reason" placeholder="Reason (optional)" class="reason-input">
            </form>
        </div>
    </section>
    {% endif %}

    <section class="job-actions-section">
        <h2>Actions</h2>

        <form class="action-form" id="status-form">
            <label for="status">Update Status:</label>
            <select name="status" id="status">
                <option value="new" {% if job.status == 'new' %}selected{% endif %}>New</option>
                <option value="interested" {% if job.status == 'interested' %}selected{% endif %}>Interested</option>
                <option value="passed" {% if job.status == 'passed' %}selected{% endif %}>Passed</option>
                <option value="applied" {% if job.status == 'applied' %}selected{% endif %}>Applied</option>
                <option value="rejected" {% if job.status == 'rejected' %}selected{% endif %}>Rejected</option>
                <option value="offer" {% if job.status == 'offer' %}selected{% endif %}>Offer</option>
            </select>
            <button type="submit" class="btn-primary">Update</button>
        </form>

        <form class="action-form" id="score-form">
            <label for="score">Score (0-10):</label>
            <input type="number" name="score" id="score" min="0" max="10" step="0.5"
                   value="{{ job.score if job.score else '' }}" required>
            <label for="rationale">Rationale:</label>
            <textarea name="rationale" id="rationale" rows="3">{{ job.score_rationale or '' }}</textarea>
            <button type="submit" class="btn-primary">Save Score</button>
        </form>
    </section>
</article>
{% endblock %}

{% block scripts %}
<script>
// Update status via AJAX
document.getElementById('status-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    const response = await fetch('{{ url_for("update_job_status", job_id=job.id) }}', {
        method: 'POST',
        body: formData
    });
    
    if (response.ok) {
        const data = await response.json();
        location.reload(); // Reload to show updated status
    } else {
        alert('Error updating status');
    }
});

// Update score via AJAX
document.getElementById('score-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    
    const response = await fetch('{{ url_for("update_job_score", job_id=job.id) }}', {
        method: 'POST',
        body: formData
    });
    
    if (response.ok) {
        const data = await response.json();
        alert('Score saved: ' + data.score + '/10');
        location.reload();
    } else {
        alert('Error updating score');
    }
});
</script>
{% endblock %}
